#!/usr/bin/env bash
#
# Copyright 2019, TAQTIQA LLC
#
# All rights reserved - Do Not Redistribute
#
# Generated by Chef Cookbook developer.chef
# Local modifications will be overridden

# A better class of script...
if [[ ${DEBUG-} =~ ^1|y|yes|true$ ]]; then
  set -o xtrace       # Trace the execution of the script (debug)
fi

set -o errexit          # Exit on most errors (see the manual)
set -o errtrace         # Make sure any error trap is inherited
set -o nounset          # Disallow expansion of unset variables
set -o pipefail         # Use last non-zero exit code in a pipeline

ASPELL="$(command -v aspell 2>/dev/null)"
if [ $? -ne 0 ]; then
  echo "WARNING: " >&2
  echo "WARNING: aspell is not installed. See 'http://aspell.net'." >&2
  echo "WARNING: " >&2
  exit 0
fi

## Ignore Git subrepo generated commit messages
#
# The subject line of the commit message tells us if the commit message is
# generated by a $(git subrepo ...) command.
#
# Example:
#
# git commit -m "git subrepo push cli/kfc.github.io                                            
#                                                                                                                  
# subrepo:                                                                                                          
#   subdir:   "cli/kfc.github.io"                                                                                   
#   merged:   "ff56c62"                                                                                             
# upstream:                                                                                                         
#   origin:   "git@github.com:bbros-dev/kfc.github.io.git"                                                          
#   branch:   "develop"                                                                                             
#   commit:   "ff56c62"                                                                                             
# git-subrepo:                
#   version:  "0.4.1"
#   origin:   "https://github.com/ingydotnet/git-subrepo.git"
#   commit:   "a04d8c2""
#
MSG="$(cat ${1})"
SBJCT=$(echo "$(cat "${1}")" | head -1)
if echo ${SBJCT} |grep -i "/subrepo/"
then
  exit 0
fi

WORDS=$(${ASPELL} --mode=email --add-email-quote='#' --list  < "${1}")
if [ -n "${WORDS}" ]; then
  echo "ERROR: possible spelling errors:" >&2
  echo "ERROR: " >&2
  echo "ERROR: ${WORDS}" >&2
  echo "ERROR: " >&2
  echo "ERROR: Correct the message or skip this warning with:" >&2
  echo "ERROR:   git commit --no-verify -m \"${MSG}\"" >&2
  exit 1
fi
