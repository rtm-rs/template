#!/usr/bin/env bash
#
# Copyright 2019, TAQTIQA LLC
#
# All rights reserved - Do Not Redistribute
#
# Generated by Chef Cookbook developer.chef
# Local modifications will be overridden
#
# NOTE:
# The `exit 0` on error ensures that `git rebase master`, and such
# commands, do not result in a detached HEAD state.
#
# Reference:
#
# * https://github.com/DrVanScott/git-clone-init
# * http://www.dvratil.cz/2015/12/git-trick-628-automatically-set-commit-author-based-on-repo-url/

# Post-Checkout hook to locally set user name and email based on user defined
# patterns.
# The patterns are matched against the clone url.

# A better class of script...
if [[ ${DEBUG-} =~ ^1|y|yes|true$ ]]; then
  set -o xtrace       # Trace the execution of the script (debug)
fi

set -o errexit          # Exit on most errors (see the manual)
set -o errtrace         # Make sure any error trap is inherited
set -o nounset          # Disallow expansion of unset variables
set -o pipefail         # Use last non-zero exit code in a pipeline

function warn {
  echo "ERROR - post-checkout hook: $*"  1>&2
}

if [[ $1 != "0000000000000000000000000000000000000000" ]]; then
  # warn "user.name and user.email already set."
  # warn "We have configured useconfigonly = true."
  # warn "Hence, we expect these values to be empty"
  # warn "until set by this local post-checkout hook."
  exit 0
fi

# Get remote name:
#   - only one: take it
#   - more: take "origin", or fail
remote="$([[ $(git remote | wc -l) -eq 1 ]] && git remote || git remote | grep "^origin$")"

if [ -z $remote ]; then
  warn "Failed to detect a git remote repository."
  exit 0
fi

export url="$(git config --get --includes remote.${remote}.url)"

if [ ! -f ~/.local/share/git/clone-init ]; then
  warn "Missing file ~/.local/share/git/clone-init."
  exit 0
fi
source ~/.local/share/git/clone-init

if ! git config --get --includes user.email
then
  warn "Failed to detect identity using ~/.local/share/git/clone-init."
  exit 0
fi
